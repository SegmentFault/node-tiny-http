// Generated by CoffeeScript 1.10.0
(function() {
  var Cookie, Response, Status, patchOriginalResponse,
    slice = [].slice;

  Cookie = require('cookie');

  Status = require('statuses');

  patchOriginalResponse = function(res) {
    var originalWrite;
    originalWrite = res.write;
    res.bytes = 0;
    return res.write = function() {
      var args, buf;
      args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      buf = args[0];
      this.bytes += buf.length;
      return originalWrite.apply(this, args);
    };
  };

  Response = (function() {
    var options;

    options = {};

    function Response(res1, opt) {
      this.res = res1;
      this.$statusCode = 200;
      this.$headers = {
        'content-type': 'text/html; charset=utf-8'
      };
      this.$cookies = [];
      this.$content = null;
      options = opt;
      this.responded = false;
      patchOriginalResponse(this.res);
    }

    Response.prototype.content = function(val) {
      this.$content = val;
      return this;
    };

    Response.prototype.status = function(code) {
      this.$statusCode = Status(code);
      return this;
    };

    Response.prototype.cookie = function(key, val, options) {
      this.$cookies.push(Cookie.serialize(key, val, options));
      return this;
    };

    Response.prototype.header = function(key, val) {
      key = key.toLowerCase();
      this.$headers[key] = val;
      return this;
    };

    Response.prototype.finish = function(finish) {
      this.finish = finish;
      return this.res.on('finish', (function(_this) {
        return function() {
          return _this.finish.call(_this, _this.res.statusCode, _this.res.bytes);
        };
      })(this));
    };

    Response.prototype.respond = function() {
      var key, ref, val;
      this.res.statusCode = this.$statusCode;
      this.res.statusMessage = Status[this.$statusCode];
      ref = this.$headers;
      for (key in ref) {
        val = ref[key];
        key = key.replace(/(^|-)([a-z])/g, function(m, a, b) {
          return a + b.toUpperCase();
        });
        this.res.setHeader(key, val);
      }
      if (this.$cookies.length > 0) {
        this.res.setHeader('Set-Cookie', this.$cookies);
      }
      if (this.$content instanceof Function) {
        return this.$content.apply(this);
      } else {
        return this.res.end(this.$content);
      }
    };

    return Response;

  })();

  module.exports = Response;

}).call(this);

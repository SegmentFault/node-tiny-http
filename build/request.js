// Generated by CoffeeScript 1.10.0
(function() {
  var Cookie, Form, Request, Url;

  Form = require('formidable');

  Url = require('url');

  Cookie = require('cookie');

  Request = (function() {
    var cookies, files, ip, mergeParams, options, params;

    params = {};

    files = {};

    cookies = {};

    options = {};

    ip = null;

    mergeParams = function(target) {
      var k, results, v;
      results = [];
      for (k in target) {
        v = target[k];
        results.push(params[k] = v);
      }
      return results;
    };

    function Request(req, opt, cb) {
      var form, parts;
      this.req = req;
      parts = Url.parse(this.req.url, true);
      options = opt;
      this.method = this.req.method.toUpperCase();
      this.uri = parts.href;
      this.scheme = parts.protocol;
      this.host = parts.hostname;
      this.port = parts.port;
      this.path = parts.pathname != null ? parts.pathname : '/';
      this.agent = this.header('user-agent');
      cookies = Cookie.parse(this.header('cookie', ''));
      params = parts.query;
      if (this.method === 'POST') {
        form = new Form.IncomingForm;
        form.parse(this.req, function(err, _fields, _files) {
          if (err != null) {
            return cb(this);
          }
          mergeParams(_fields);
          files = _files;
          return cb(this);
        });
      } else {
        cb(this);
      }
    }

    Request.prototype.ip = function() {
      var defaults, i, key, len, val;
      defaults = ['x-real-ip', 'x-forwarded-for', 'client-ip'];
      if (ip == null) {
        if (options.ipHeader != null) {
          ip = this.header(options.ipHeader, this.req.socket.remoteAddress);
        } else {
          for (i = 0, len = defaults.length; i < len; i++) {
            key = defaults[i];
            val = this.header(key);
            if (val != null) {
              ip = val;
              break;
            }
          }
          ip = this.req.socket.remoteAddress;
        }
      }
      return ip;
    };

    Request.prototype.header = function(key, val) {
      if (val == null) {
        val = null;
      }
      key = key.toLowerCase();
      if (this.req.headers[key]) {
        return this.req.headers[key];
      } else {
        return val;
      }
    };

    Request.prototype.cookie = function(key, val) {
      if (val == null) {
        val = null;
      }
      if (cookies[key] != null) {
        return cookies[key];
      } else {
        return val;
      }
    };

    Request.prototype.is = function(query) {
      var k, required, v;
      required = querystring.parse(query);
      for (k in required) {
        v = required[k];
        if ((v != null) && v.length > 0) {
          if (v !== this.get(k)) {
            return true;
          }
        } else {
          if ((this.get(k)) === null) {
            return true;
          }
        }
      }
      return false;
    };

    Request.prototype.set = function(key, val) {
      if (val == null) {
        val = null;
      }
      if (val === null && key instanceof Object) {
        return mergeParams(key);
      } else {
        return params[key] = val;
      }
    };

    Request.prototype.get = function(key, defaults) {
      if (defaults == null) {
        defaults = null;
      }
      if (params[key] != null) {
        return params[key];
      } else {
        return defaults;
      }
    };

    Request.prototype.file = function(key) {
      if (files[key] != null) {
        return files[key];
      } else {
        return null;
      }
    };

    return Request;

  })();

  module.exports = Request;

}).call(this);
